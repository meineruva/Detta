rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Deny default
    match /{document=**} {
      allow read, write: if false;
    }

    // Users: Read own profile, Write own profile (limited fields ideally, but allowing for now based on plan)
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId; // Ideally strict schema validation
    }
    
    // Users by Username: Read-only for auth lookup
    match /users_by_username/{username} {
      allow get: if request.auth != null; // Allow get specific doc (lookup)
    }

    // Attendance Records: Read own, Staff read all. DENY direct writes (must go through Function)
    match /attendance/{date}/records/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isStaff());
      allow write: if false; // Must use submitAttendance function
    }
    
    // Attendance Summaries: Staff read only. Deny writes.
    match /attendance/{date}/summary/{docId} {
        allow read: if request.auth != null && isStaff();
        allow write: if false; // Must use Functions
    }

    // Absence Requests: Create own, Read own. Staff read/write (review).
    match /absenceRequests/{requestId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isStaff());
      allow update: if request.auth != null && isStaff(); // Staff reviews
    }
    
    // Staff Whitelist: Read-only for everyone (or protected? App needs to query it).
    // Better: Read-only for authenticated users to check their own role? 
    // Plan says: "protected users/classes/whitelist collections accordingly"
    match /staffWhitelist/{email} {
        allow read: if request.auth != null;
        allow write: if false; // Admin console only
    }

    function isStaff() {
       // Logic to check if user is staff. 
       // Often requires custom claims or a look up. 
       // For now, assuming custom claim 'role' or simple check if we could.
       // Without custom claims, we'd need get(). 
       // Let's assume for this stage, strict deny on sensitive paths is key.
       // We'll trust backend functions for writes.
       // For reads, we might need a more robust staff check later.
       return request.auth.token.role == 'admin' || request.auth.token.role == 'staff'; 
    }
  }
}
