rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Deny default
    // Flagged Check-Ins
    // Flagged Check-Ins
    match /flaggedCheckIns/{docId} {
      allow read: if request.auth != null && isStaff();
      allow write: if false; // Only Cloud Functions (Admin SDK)
    }
    
    // Device Reset Logs
    match /deviceResetLogs/{docId} {
      allow read: if request.auth != null && isStaff();
      allow write: if false; // Only Cloud Functions
    }

    // Users: Read own, Staff read all student profiles. 
    // Write own profile BUT deny writing to 'role', 'email', 'classId'. Allow 'boundDevice'.
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isStaff());
      allow write: if request.auth != null && request.auth.uid == userId && 
         (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'email', 'classId'])); 
    }
    
    // Users by Username: Read-only for auth lookup
    // Users by Username: Read-only for auth lookup
    match /users_by_username/{username} {
      allow get: if true; // Public lookup for login
      allow write: if false; // Only Cloud Functions
    }

    // Attendance Records: Read own, Staff read all. DENY direct writes (must go through Function)
    match /attendance/{date}/records/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isStaff());
      allow write: if false; // Must use submitAttendance function
    }
    
    // Attendance Summaries: Staff read only. Deny writes.
    match /attendance/{date}/summary/{docId} {
        allow read: if request.auth != null && isStaff();
        allow write: if false; // Must use Functions
    }

    // Absence Requests: Create own, Read own. Staff read/write (review).
    match /absenceRequests/{requestId} {
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isStaff());
        allow update: if request.auth != null && isStaff(); // Staff reviews
    }
    
    // Staff Whitelist: Read-only for Authenticated (to check roles). Write: Admin via Console/Functions only (or strictly limited)
    // Comment says "restrict staffWhitelist writes to admins".
    // We can allow write if the user is an admin check.
    match /staffWhitelist/{email} {
        allow read: if request.auth != null;
        allow write: if isStaff() && request.auth.token.role == 'admin'; // Assuming custom claim or trusting source for now
    }

    // Classes: Read/Write by Staff/Admin
    match /classes/{classId} {
        allow read: if request.auth != null && isStaff();
        allow write: if request.auth != null && isStaff();
    }

    function isStaff() {
       // Logic to check if user is staff. 
       // Often requires custom claims or a look up. 
       // For now, assuming custom claim 'role' or simple check if we could.
       // Without custom claims, we'd need get(). 
       // Let's assume for this stage, strict deny on sensitive paths is key.
       // We'll trust backend functions for writes.
       // For reads, we might need a more robust staff check later.
       return request.auth.token.role == 'admin' || request.auth.token.role == 'staff'; 
    }
  }
}
